apiVersion: metrics.keptn.sh/v1beta1
kind: KeptnMetricsProvider
metadata:
  labels:
    app.kubernetes.io/name: keptnmetricsprovider
    app.kubernetes.io/instance: keptnmetricsprovider
    app.kubernetes.io/part-of: keptn-lifecycle-toolkit
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/created-by: metrics-operator
  name: keptnmetricsprovider
spec:
  type: "prometheus"
  targetServer: "http://prometheus-k8s.monitoring.svc.cluster.local:9090"
  secretKeyRef:
    name: "prometheusLoginCredentials"
    key: "my-credentials"
# v1beta1,KeptnMetric cannot be applied to the cluster due to the presence of
# conversion webhook for KeptnMetric CRD
# The non-existence of conversion path from v1beta1 to v1alpha3 (HUB)
# causes the system to refuse this CR when applied
# ---
# apiVersion: metrics.keptn.sh/v1beta1
# kind: KeptnMetric
# metadata:
#   labels:
#     app.kubernetes.io/name: keptnmetric
#     app.kubernetes.io/instance: keptnmetric
#     app.kubernetes.io/part-of: keptn-lifecycle-toolkit
#     app.kubernetes.io/managed-by: kustomize
#     app.kubernetes.io/created-by: metrics-operator
#   name: keptnmetric
# spec:
#   provider:
#     name: some-name
#   query: "sum(kube_pod_container_resource_limits{resource='cpu'}) - sum(kube_node_status_capacity{resource='cpu'})"
#   fetchIntervalSeconds: 10
#   range:
#     interval: "5m"
---
apiVersion: metrics.keptn.sh/v1beta1
kind: AnalysisValueTemplate
metadata:
  labels:
    app.kubernetes.io/name: analysisvaluetemplate
    app.kubernetes.io/instance: analysisvaluetemplate
    app.kubernetes.io/part-of: metrics-operator
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/created-by: metrics-operator
  name: response-time-p95
  namespace: keptn-lifecycle-toolkit-system
spec:
  provider:
    name: prometheus
  query: "sum(kube_pod_container_resource_limits{node='{{.nodename}}'}) - sum(kube_node_status_capacity{node='{{.nodename}}'})"
---
apiVersion: metrics.keptn.sh/v1beta1
kind: AnalysisDefinition
metadata:
  name: ed-my-proj-dev-svc1
  namespace: keptn-lifecycle-toolkit-system
spec:
  objectives:
    - analysisValueTemplateRef:
        name: response-time-p95
        namespace: keptn-lifecycle-toolkit-system
      target:
        failure:
          lessThan:
            fixedValue: 600
        warning:
          inRange:
            lowBound: 300
            highBound: 500
      weight: 1
      keyObjective: false
  totalScore:
    passPercentage: 90
    warningPercentage: 75
---
apiVersion: metrics.keptn.sh/v1beta1
kind: Analysis
metadata:
  labels:
    app.kubernetes.io/name: analysis
    app.kubernetes.io/instance: analysis
    app.kubernetes.io/part-of: metrics-operator
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/created-by: metrics-operator
  name: analysis
spec:
  timeframe:
    from: 2023-05-05T05:05:05Z
    to: 2023-05-05T10:10:10Z
  args:
    project: my-project
    stage: dev
    service: svc1
    nodename: test
  analysisDefinition:
    name: ed-my-proj-dev-svc1
    namespace: keptn-lifecycle-toolkit-system
